<!DOCTYPE html>
<html lang="en">
  <head>
    <script defer type="module">
      import { record } from './util/recorder/recorder-main.js';
      import { beCloseTo, test, evaluate } from './util/audit.js';

      test((async () => {
        const context = new AudioContext({sampleRate: 48000});
        const constantSource = new ConstantSourceNode(context);
        const gainNodes = Array(100).fill().map(() => new GainNode(context));
        const renderLength = 1; // second
        const {recorder, bufferPromise} = await record(context, renderLength);
        gainNodes.forEach((g, i) => i !== 0 && gainNodes[i - 1].connect(g));
        constantSource.connect(gainNodes[0]);
        // connect last gain node to recorder
        gainNodes.at(-1).connect(recorder).connect(context.destination);

        constantSource.start();

        const audioBuffer = await bufferPromise;
        const leftChannelFloat32Array = audioBuffer.getChannelData(0);

        await context.close();
        return leftChannelFloat32Array;
      })());

      evaluate(async (testResult) => {
        const leftChannelFloat32Array = await testResult;
        let numberOfAcceptableSamples = 0;
        for (let i = 0; i < leftChannelFloat32Array.length; i++) {
          numberOfAcceptableSamples += beCloseTo(leftChannelFloat32Array[i], 1, 0);
        }
        console.info('% match:', numberOfAcceptableSamples / leftChannelFloat32Array.length);

        // return true if 99.99% pass
        return numberOfAcceptableSamples / leftChannelFloat32Array.length > .9999;
      });
    </script>
    <title>Gain Performance</title>
  </head>
  <body></body>
</html>
