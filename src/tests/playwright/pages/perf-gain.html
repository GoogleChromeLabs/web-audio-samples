<!DOCTYPE html>
<html lang="en">
  <head>
    <script defer type="module">
      import { record } from './processors/recorder/recorder-main.js';
      import { beCloseTo, test, evaluate } from './util/audit.js';

      test((async () => {
        const ctx = new AudioContext({sampleRate: 48000});
        const src = new ConstantSourceNode(ctx);
        const gs = Array(100).fill().map(() => new GainNode(ctx));
        const length = 1; // second
        const {recorder, bufferPromise} = await record(ctx, length);
        gs.forEach((g, i) => i !== 0 && gs[i - 1].connect(g));
        src.connect(gs[0]);
        gs.at(-1).connect(recorder).connect(ctx.destination);

        src.start();
        src.stop(ctx.currentTime + 1);

        const audioBuffer = await bufferPromise;
        const float32Buffer = audioBuffer.getChannelData(0);

        await ctx.close();
        return {buffer: float32Buffer};
      })());

      evaluate(async () => {
        const bufferData = (await window.test).buffer;
        let numCorrect = 0;
        for (let i = 0; i < bufferData.length; i++) {
          numCorrect += beCloseTo(bufferData[i], 1, 0) ? 1 : 0;
        }
        console.info('% match:', numCorrect / bufferData.length);

        // return true if 99.99% pass
        return numCorrect / bufferData.length > .9999;
      });
    </script>
    <title>Gain Performance</title>
  </head>
  <body></body>
</html>
