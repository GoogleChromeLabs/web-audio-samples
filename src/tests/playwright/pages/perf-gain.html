<!DOCTYPE html>
<html lang="en">
  <head>
    <script defer type="module">
      import {record} from './util/recorder/recorder-main.js';
      import {test, evaluateTest, assert, beCloseTo} from './util/audit.js';

      const NUM_GAIN_NODES = 100;

      test((async () => {
        const context = new AudioContext({sampleRate: 48000});
        const constantSource = new ConstantSourceNode(context);
        const gainNodes = Array(NUM_GAIN_NODES).fill().map(() => new GainNode(context));
        const duration = 1; // second
        const {recorder, recordingCompletePromise} = await record(context, duration);
        gainNodes.forEach((g, i) => i !== 0 && gainNodes[i - 1].connect(g));
        constantSource.connect(gainNodes[0]);
        // connect last gain node to recorder
        gainNodes.at(-1).connect(recorder).connect(context.destination);

        constantSource.start();

        const recordChannelData = await recordingCompletePromise;
        const leftChannelFloat32Array = recordChannelData[0];

        await context.close();
        return leftChannelFloat32Array;
      })());

      evaluateTest((testResult) => {
        const leftChannelFloat32Array = testResult;
        for (let i = 0; i < leftChannelFloat32Array.length; i++) {
          assert(beCloseTo(leftChannelFloat32Array[i], 1, 0));
        }

        return assert();
      });
    </script>
    <title>Gain Performance Test</title>
  </head>
  <body>
    <h1>Gain Performance Test</h1>
    <p>Test performance of ConstantSourceNode => 100 Gain Nodes; Port of <a href="https://source.chromium.org/chromium/chromium/src/+/main:third_party/blink/perf_tests/webaudio/gain-node.html">Blink WPT Performance Gain Test</a></p>
  </body>
</html>
