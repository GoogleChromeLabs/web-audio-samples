<!DOCTYPE html>
<html lang="en">
  <head>
    <script defer type="module">
      import {record} from './util/recorder/recorder-main.js';
      import {beCloseTo, test, evaluate} from './util/audit.js';

      test((async () => {
        const context = new AudioContext({sampleRate: 48000});
        const oscillator = new OscillatorNode(context);
        const duration = 1; // second
        const {recorder, bufferPromise} = await record(context, duration);
        oscillator.connect(recorder).connect(context.destination);

        oscillator.start();

        const audioBuffer = await bufferPromise;
        const float32Buffer = audioBuffer.getChannelData(0);

        await context.close();
        return {buffer: float32Buffer};
      })());

      evaluate(async testResult => {
        const bufferData = (await testResult).buffer;
        const myRefData = await (await fetch('./reference/440@48k-sine-octx.json')).json();

        // compare bufferData samples to reference
        let numberOfAcceptableSamples = 0;
        for (let i = 0; i < bufferData.length; i++) {
          numberOfAcceptableSamples += beCloseTo(bufferData[i], myRefData[i], 0.01) ? 1 : 0;
        }
        console.info('% match:', numberOfAcceptableSamples / bufferData.length);

        // return true if 99.8% pass
        return numberOfAcceptableSamples / bufferData.length > .998;
      });
    </script>
    <title>Realtime Sine Oscillator Test</title>
  </head>
  <body>
    <h1>Realtime Sine Oscillator Test</h1>
    <p>Play a sine wave at 440Hz for 1 second at 48kHz sample rate.</p>
  </body>
</html>
