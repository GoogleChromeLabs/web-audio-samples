# Terry Feng - Google Summer of Code 2024

## Overview 
**Contributor**: Terry Feng ([@terryzfeng](https://github.com/terryzfeng)) <br>
**Mentors**: Hongchan Choi ([@hoch](https://github.com/hoch)),
Michael Wilson ([@mjwilson-google](https://github.com/mjwilson-google)) <br>
**Organization**: Chromium - Web Audio Team <br>
**Project(s)**: 
1. [Web Audio Test Suite](#web-audio-test-suite)
2. [Rainfly: An AudioWorklet DSP Playground](#rainfly-an-audioworklet-dsp-playground)

## Description

This summer, I had the pleasure of working with the Chromium Web Audio Team on
two projects: building a **Web Audio Test Suite** and creating **Rainfly: An AudioWorklet DSP Playground**.
The Web Audio Test Suite enables Web Audio developers to write performance and
benchmark tests for Web Audio, executing them live in an interactive webpage or
via the Playwright test framework for CI. Rainfly is an online IDE for writing
`AudioWorklet` code in JavaScript and visualizing realtime `AudioContext` output
for analysis.

## What I Did

### Web Audio Test Suite

GitHub: [Web Audio Test Suite](https://github.com/GoogleChromeLabs/web-audio-samples/tree/main/src/tests/playwright)

1. This project began with research in JavaScript testing frameworks and finding
a lightweight solution for verifying browser JS execution for Web Audio. We
decided upon using the [Playwright](https://playwright.dev) testing framework
developed by Microsoft. The main reasons were:
    - Streamlined E2E testing and browser emulation (Chromium, Canary, Chrome)
    via CLI
    - The ability to write vanilla Web Audio JS and use Hooks and Promises
    to verify test logic
    - Minimal overhead for Web Audio performance benchmarking
    - CI via GitHub Actions
2. Within the Playwright test framework paradigm, I helped create a custom Web
Audio test library (`audit.js`) that sandboxes test code for test execution
timing and evaluation code for test logic verification. 
    - Challenges that we overcame include:
        - Creating the API to set up global test logic needed for arbitrary
        asynchronous JS execution and verification maintaining Playwright compatability
        - Finding appropriate thresholds for verifying "correct" `float32` samples
        generated by different machines, browsers, and architectures 
        - Designing the writing of tests to be natural and intuitive for future
        developers
3. After Playwright CLI testing, I worked with ([@kizjkre](https://github.com/kizjkre))
to create an interactive Live Suite webpage for executing the same Web Audio tests
in a local browser.
    - We enhanced `audit.js` to be flexible running within Playwright CLI as
    well as in a sandboxed manner running in a live browser webpage
4. I finally ported over many of the existing Web Audio tests into our Web Audio
Test Suite.

### Rainfly: An AudioWorklet DSP Playground

GitHub: *In Progress*

1. Rainfly is modern version of Hongchan's [Canopy](https://hoch.github.io/canopy/)
project designed specifically for `AudioWorklet` (AW) implementation writing,
visualization, and analysis. [@kizjkre](https://github.com/kizjkre) and I created
a [Figma](https://www.figma.com/proto/NrpvA1wwQNoc4hnKTAORIg/Rainfly?node-id=1-2&t=yNQPbNlEnX24i2MJ-0)
prototype to capture and design ideas for the tools and features that a modern
AW DSP playground could offer.
2. I implemented Rainfly's code editor using [Monaco](https://microsoft.github.io/monaco-editor)
and handled JS code preprocessing, execution, and sandboxing for
`AudioWorkletProcessor` and `AudioContext` creation. I additionally created
various [Svelte](https://svelte.dev) components to control audio host playback.
3. Rainfly includes an internal AW audio recorder that captures PCM samples and
streams them for visualization. To ensure this process was efficient and 
seamless for the user, I:
    - JS injected Rainfly's recorder node into the user's code just before
    `context.destination`
    - Efficiently handled realtime writing of millions of `process()` samples at
    audio rate while reading and rendering them using the Canvas API at graphics
    rate. 

## Code and PRs

### Merged:
- [Playwright MVP](https://github.com/GoogleChromeLabs/web-audio-samples/pull/372)
- [Web Audio Test Suite Documentation](https://github.com/GoogleChromeLabs/web-audio-samples/pull/381)
- [Port Web Audio Performance Tests from WPT](https://github.com/GoogleChromeLabs/web-audio-samples/pull/384)

### Open PRs:
- [Rainfly MVP](https://github.com/GoogleChromeLabs/web-audio-samples/pull/395)

## Future Work
- Web Audio Test Suite: Ensuring that developers are able to effectively write
tests and benchmark Web Audio performance and functionality.
- Rainfly: Merging the current PR and deploying the first MVP of Rainfly to 
Web Audio Samples.
    - Feature improvements to add: 
        - Improving the visualizer by adding a time axis and sample popup on
        hover for numerical feedback 
        - Smooth zooming in-out and scrolling left and right in the visualizer
        window

## Reflections and Takeaways

Working with my mentors Hongchan and Michael, I've learned a lot of best
practices for writing easy-to-read code, communicating effectively during code
review, and how to build projects effectively while navigating engineering,
design, and architectural decisions. It was a great experience to practice these
skills more, and my mentors were really supportive showing me the ropes. 

In laying the groundwork for the Web Audio Test Suite, it was challenging and
quite tedious to spend time considering _all_ the current testing needs of the
team, finding good solutions to benchmark and analyze performance of real-time
Web Audio (this was harder than I thought), and to build a test framework
flexible for future use cases. This required extensive research to implement
an all-in-one creative testing API balancing tools, technologies, and code.
However, this project will be extrememly beneficial and makes it so much easier
for future Web Audio testing.

In working on Rainfly, I got the chance to learn and use a JS framework for the
first time (Svelte), make stylistic and creative UI/UX decisions for a "cute" IDE,
and implement important AW tooling for making custom DSP. This leveraged
a lot of my skills beyond pure software engineering which was rigorous, imaginative,
and rewarding. 

Overall I'd like to thank my mentors Hongchan Choi and Michael Wilson, my
fellow sumer partner in crime Web Audio GSoC contributor ([@kizjkre](https://github.com/kizjkre)),
and look forward to seeing my project work this summer being used internally
and externally for Web Audio developers. I hope to continue contributing to the
Chromium organization and Web Audio project in the near future!
