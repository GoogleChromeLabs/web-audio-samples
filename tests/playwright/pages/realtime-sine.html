<!DOCTYPE html>
<html lang="en">
  <head>
    <script defer type="module">
      import record from './processors/recorder/recorder-main.js';
      import { beCloseTo, test, evaluate } from './util/audit.js';

      test((async () => {
        const ctx = new AudioContext({sampleRate: 48000});
        const helloSine = new OscillatorNode(ctx);
        const length = 1; // second
        const {recorder, buffer} = await record(ctx, length);
        helloSine.connect(recorder).connect(ctx.destination);

        helloSine.start();
        helloSine.stop(ctx.currentTime + 1);

        const audioBuffer = await buffer;
        const float32Buffer = audioBuffer.getChannelData(0);

        await ctx.close();
        return {buffer: float32Buffer};
      })());

      evaluate(async () => {
        const bufferData = (await window.test).buffer;
        const myRefData = await (await fetch('./reference/440@48k-sine-octx.json')).json();

        // compare bufferData samples to reference
        let numCorrect = 0;
        for (let i = 0; i < bufferData.length; i++) {
          numCorrect += beCloseTo(bufferData[i], myRefData[i], 0.001) ? 1 : 0;
        }

        console.info('% match:', numCorrect / bufferData.length);
        // expect 99.99%
        return numCorrect / bufferData.length > .9999;
      });
    </script>
    <title>Realtime Sine</title>
  </head>
  <body>
    <h1>Realtime Sine Test</h1>
    <p>Play a sine wave at 440Hz for 1 second, sampleRate: 48000</p>
  </body>
</html>
